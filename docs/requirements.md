# Multicloud Exporter - 需求文档

## 文档版本
- **版本号：** v1.0
- **创建日期：** 2025-12-30
- **最后更新：** 2026-01-04
- **状态：** 正式发布

## 1. 项目背景

### 1.1 业务背景
企业在多云环境下运营时，需要监控各个云平台的资源状态和性能指标。各云厂商提供的监控接口和指标格式不统一，导致：
- 需要为每个云平台单独部署监控组件
- 缺乏统一的监控视图和告警规则
- 运维成本高，管理复杂

### 1.2 项目目标
构建一个统一的多云资源监控导出器，实现：
- 统一的监控指标格式（Prometheus 兼容）
- 支持多个云平台（阿里云、腾讯云、华为云、AWS）
- 降低 API 调用成本和云厂商配额消耗
- 支持多账号、多区域、多资源类型的监控
- 提供高性能、高可靠的监控数据采集

## 2. 功能需求

### 2.1 多云平台支持 [FR-001]

**需求描述：** 支持多个主流云平台的资源监控

**子需求：**

| ID | 云平台 | 支持的资源类型 | 优先级 |
|---|---|---|---|
| FR-001-01 | 阿里云 (Aliyun) | 共享带宽包 (CBWP)、负载均衡 (ALB/CLB/NLB/GWLB)、对象存储 (OSS) | P0 |
| FR-001-02 | 腾讯云 (Tencent) | 共享带宽包 (BWP)、负载均衡 (CLB/GWLB)、对象存储 (COS) | P0 |
| FR-001-03 | 华为云 (Huawei) | 弹性负载均衡 (ELB)、对象存储 (OBS) | P1 |
| FR-001-04 | AWS | 负载均衡 (ALB/CLB/NLB/GWLB)、对象存储 (S3) | P0 |

**验收标准：**
- [ ] 能够成功连接各云平台 API
- [ ] 能够正确获取各云平台的监控数据
- [ ] 监控数据包含各云平台的关键指标

### 2.2 多账号、多区域监控 [FR-002]

**需求描述：** 支持配置多个云账号，每个账号可以监控多个区域

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-002-01 | 支持配置多个云账号（AccessKey ID/Secret） | P0 |
| FR-002-02 | 支持按账号、区域、资源类型区分监控指标标签 | P0 |
| FR-002-03 | 支持通配符配置 `regions: ["*"]` 自动发现所有区域 | P1 |
| FR-002-04 | 提供区域枚举失败时的回退机制（DEFAULT_REGIONS 环境变量） | P2 |

**验收标准：**
- [ ] 一个实例可以监控多个账号的多个区域
- [ ] 指标标签包含 `account_id`、`region`、`resource_type`
- [ ] 通配符配置能够自动发现所有可用区域
- [ ] 区域枚举失败时能够回退到预定义区域列表

### 2.3 资源发现与指标采集 [FR-003]

**需求描述：** 自动发现云资源并采集监控指标

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-003-01 | 自动枚举各云平台的资源 ID（如 OSS Bucket、LB 实例 ID） | P0 |
| FR-003-02 | 资源发现结果支持缓存，可配置 TTL | P0 |
| FR-003-03 | 支持按资源类型过滤采集（`resources` 配置） | P1 |
| FR-003-04 | 支持通配符 `resources: ["*"]` 采集所有资源类型 | P1 |
| FR-003-05 | 提供资源发现状态查询接口 `/api/discovery/resources` | P2 |
| FR-003-06 | 提供配置查询接口 `/api/discovery/config` | P2 |

**验收标准：**
- [ ] 能够正确枚举各云平台的资源
- [ ] 资源发现结果在 TTL 内被缓存
- [ ] 支持按资源类型过滤采集
- [ ] 通配符配置能够采集所有资源类型
- [ ] 资源发现接口返回正确的资源列表
- [ ] 配置查询接口返回当前配置信息

### 2.4 Prometheus 兼容的指标暴露 [FR-004]

**需求描述：** 以 Prometheus 格式暴露监控指标

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-004-01 | 提供 `/metrics` 端点，输出 Prometheus 文本格式 | P0 |
| FR-004-02 | 指标名称遵循 Prometheus 命名规范 | P0 |
| FR-004-03 | 指标包含标准的 Prometheus 标签（`__name__` 等） | P0 |
| FR-004-04 | 业务指标使用统一的命名前缀 `multicloud_` | P0 |
| FR-004-05 | 跨云同类资源的指标命名统一（如 `clb_traffic_rx_bps`） | P1 |
| FR-004-06 | 提供健康检查端点 `/-/healthy` | P2 |

**验收标准：**
- [ ] `/metrics` 端点返回 Prometheus 文本格式数据
- [ ] 指标名称符合 Prometheus 命名规范
- [ ] 业务指标以 `multicloud_` 为前缀
- [ ] 跨云同类资源的指标命名统一
- [ ] `/-/healthy` 端点返回 `OK`

### 2.5 配置管理 [FR-005]

**需求描述：** 提供灵活的配置管理方式

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-005-01 | 配置文件拆分为 `server.yaml` 和 `accounts.yaml` | P0 |
| FR-005-02 | 支持通过环境变量覆盖配置（如 `EXPORTER_PORT`） | P0 |
| FR-005-03 | 支持环境变量注入凭证（避免明文存储） | P0 |
| FR-005-04 | 支持配置文件路径自定义（`CONFIG_PATH`） | P1 |
| FR-005-05 | 启动时验证配置合法性 | P0 |
| FR-005-06 | 提供配置验证工具 `cmd/mappings-check` | P2 |

**验收标准：**
- [ ] 配置文件能够正确加载和解析
- [ ] 环境变量能够覆盖配置文件中的值
- [ ] 凭证可以通过环境变量注入
- [ ] 支持自定义配置文件路径
- [ ] 配置错误时能够明确提示
- [ ] 配置验证工具能够检测配置问题

### 2.6 集群部署支持 [FR-006]

**需求描述：** 支持多种集群部署模式以应对大规模监控场景

**子需求：**

| ID | 部署模式 | 需求描述 | 优先级 |
|---|---|---|---|
| FR-006-01 | 单机模式 | 默认模式，适用于小规模场景 | P0 |
| FR-006-02 | 静态分片 | 通过环境变量 `EXPORT_SHARD_TOTAL` 和 `EXPORT_SHARD_INDEX` 手动分片，适用于 Docker Compose 或物理机集群 | P1 |
| FR-006-03 | Kubernetes 动态分片 | 利用 Headless Service 自动发现对等节点并分片，支持扩缩容 | P1 |
| FR-006-04 | 分片算法 | 使用 FNV-32a 哈希算法进行区域级和产品级分片 | P0 |

**验收标准：**
- [ ] 单机模式能够正常工作
- [ ] 静态分片能够按配置分配采集任务
- [ ] Kubernetes 动态分片能够自动发现节点并平衡负载
- [ ] 分片算法能够均匀分配采集任务

### 2.7 性能优化 [FR-007]

**需求描述：** 优化 API 调用效率和采集性能

**子需求：**

| ID | 优化措施 | 需求描述 | 优先级 |
|---|---|---|---|
| FR-007-01 | 资源 ID 缓存 | 缓存枚举的资源 ID，避免重复 API 调用 | P0 |
| FR-007-02 | 标签缓存 | 缓存资源标签（如 `code_name`），同一资源的多个指标复用缓存 | P0 |
| FR-007-03 | 智能区域发现 | 自动识别有资源的区域，跳过无资源区域，定期重新发现 | P1 |
| FR-007-04 | 智能分页保护 | 为分页 API 添加保护机制，防止无限循环 | P1 |
| FR-007-05 | 首次采集错峰 | 支持智能错峰策略，避免多 Pod 并发首次采集 | P1 |
| FR-007-06 | Period 自动适配 | 自动获取指标支持的 Period，选择最小值 | P2 |

**验收标准：**
- [ ] 资源 ID 在 TTL 内被缓存
- [ ] 标签缓存减少 VPC API 调用（目标减少 90%）
- [ ] 智能区域发现能够跳过无资源区域
- [ ] 分页保护机制防止无限循环
- [ ] 首次采集错峰策略能够均匀分布启动时间
- [ ] Period 自动适配能够选择最小值

### 2.8 自身监控 [FR-008]

**需求描述：** 提供导出器自身的监控指标

**子需求：**

| ID | 指标类型 | 需求描述 | 优先级 |
|---|---|---|---|
| FR-008-01 | API 请求耗时 | 记录各云平台 API 请求耗时（直方图） | P0 |
| FR-008-02 | API 限流统计 | 统计各云平台 API 限流次数 | P0 |
| FR-008-03 | 采集周期耗时 | 记录每次采集周期的总耗时（直方图） | P0 |
| FR-008-04 | 采集状态 | 记录各账号的采集状态 | P1 |
| FR-008-05 | 区域状态统计 | 记录智能区域发现的状态统计 | P2 |

**验收标准：**
- [ ] API 请求耗时指标正确记录
- [ ] API 限流统计准确
- [ ] 采集周期耗时指标正确记录
- [ ] 采集状态接口返回正确的状态信息
- [ ] 区域状态统计指标正确记录

### 2.9 管理接口与认证 [FR-009]

**需求描述：** 为管理接口提供安全认证机制

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-009-01 | 支持 BasicAuth 认证 `/api/discovery/*` 端点 | P1 |
| FR-009-02 | 支持通过环境变量配置认证信息 | P1 |
| FR-009-03 | 支持 Kubernetes Secret 管理认证信息 | P1 |
| FR-009-04 | 支持多账号认证配置 | P2 |

**验收标准：**
- [ ] BasicAuth 认证能够正确拦截未授权请求
- [ ] 认证信息可以通过环境变量配置
- [ ] Kubernetes Secret 能够正确注入认证信息
- [ ] 多账号认证配置能够正常工作

### 2.10 Kubernetes 部署支持 [FR-010]

**需求描述：** 提供 Helm Chart 支持 Kubernetes 部署

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-010-01 | 提供 Helm Chart，支持 Deployment 和 StatefulSet | P1 |
| FR-010-02 | 支持通过 values.yaml 自定义配置 | P1 |
| FR-010-03 | 支持区域发现数据的持久化存储（PVC 或 emptyDir） | P1 |
| FR-010-04 | 支持配置文件通过 ConfigMap 挂载 | P2 |
| FR-010-05 | 支持通过 Kubernetes Secret 管理凭证 | P2 |

**验收标准：**
- [ ] Helm Chart 能够成功部署
- [ ] values.yaml 能够正确覆盖默认配置
- [ ] 区域发现数据能够持久化存储
- [ ] ConfigMap 能够正确挂载配置文件
- [ ] Secret 能够正确注入凭证

### 2.11 日志管理 [FR-011]

**需求描述：** 提供灵活的日志配置和输出方式

**子需求：**

| ID | 需求描述 | 优先级 |
|---|---|---|
| FR-011-01 | 支持结构化日志（JSON 格式） | P1 |
| FR-011-02 | 支持多种日志级别（debug, info, warn, error） | P0 |
| FR-011-03 | 支持多种输出方式（stdout、file、both） | P1 |
| FR-011-04 | 支持日志文件轮转（大小、数量、时间限制） | P2 |

**验收标准：**
- [ ] 日志能够以 JSON 格式输出
- [ ] 日志级别能够正确配置
- [ ] 日志能够输出到指定目标（stdout/file/both）
- [ ] 日志文件轮转能够正常工作

## 3. 非功能需求

### 3.1 性能需求 [NFR-001]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-001-01 | 单账号单区域采集时间 | < 10s（正常情况） |
| NFR-001-02 | 总采集周期 | 可配置，默认 60s |
| NFR-001-03 | API 调用减少率 | 标签缓存减少 VPC API 调用 90% |
| NFR-001-04 | 智能区域发现 API 减少 | 跳过无资源区域，减少 50-90% API 调用 |
| NFR-001-05 | 并发采集能力 | 支持多账号并发采集 |

### 3.2 可靠性需求 [NFR-002]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-002-01 | API 调用重试 | 支持可配置的重试次数和超时 |
| NFR-002-02 | 错误处理 | 单账号采集失败不影响其他账号 |
| NFR-002-03 | 优雅关闭 | 收到 SIGTERM/SIGINT 信号后优雅关闭 |
| NFR-002-04 | 配置热更新 | 监听配置文件变化并自动重载（仅资源集合） |
| NFR-002-05 | 分页保护 | 防止 API bug 导致的无限循环 |

### 3.3 可扩展性需求 [NFR-003]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-003-01 | 云平台扩展 | 提供统一的 Provider 接口，易于添加新云平台 |
| NFR-003-02 | 资源类型扩展 | 支持通过配置文件添加新的资源类型 |
| NFR-003-03 | 指标映射扩展 | 支持通过 YAML 文件自定义指标映射 |
| NFR-003-04 | 集群扩缩容 | Kubernetes 模式支持动态扩缩容 |

### 3.4 安全性需求 [NFR-004]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-004-01 | 凭证安全 | 不在代码仓库中存储明文凭证 |
| NFR-004-02 | 传输安全 | 生产环境建议使用 HTTPS 传输管理接口数据 |
| NFR-004-03 | 访问控制 | 管理接口支持 BasicAuth 认证 |
| NFR-004-04 | 容器安全 | Docker 容器以非 root 用户运行 |
| NFR-004-05 | 配置验证 | 启动时验证配置合法性 |

### 3.5 可观测性需求 [NFR-005]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-005-01 | 自身监控指标 | 提供完整的自身监控指标（API 耗时、限流、采集状态） |
| NFR-005-02 | 采集日志 | 提供详细的采集过程日志 |
| NFR-005-03 | 错误日志 | 错误信息包含足够的上下文 |
| NFR-005-04 | 健康检查 | 提供健康检查端点 |
| NFR-005-05 | 资源发现接口 | 提供资源发现状态查询接口 |

### 3.6 兼容性需求 [NFR-006]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-006-01 | Go 版本 | Go 1.25+ |
| NFR-006-02 | 操作系统 | Linux、macOS、Windows |
| NFR-006-03 | Kubernetes 版本 | Kubernetes 1.20+ |
| NFR-006-04 | Prometheus 版本 | Prometheus 2.0+ |

### 3.7 可维护性需求 [NFR-007]

| ID | 需求描述 | 目标值 |
|---|---|---|
| NFR-007-01 | 代码质量 | 遵循 Go 语言规范，通过 golangci-lint 检查 |
| NFR-007-02 | 测试覆盖率 | 全局覆盖率 ≥ 80%，目标 ≥ 90% |
| NFR-007-03 | 文档完整性 | 提供完整的 README、配置示例和 API 文档 |
| NFR-007-04 | 版本管理 | 使用语义化版本（vX.Y.Z） |

## 4. 约束条件

### 4.1 技术约束
- 必须使用 Go 语言开发
- 必须兼容 Prometheus 指标格式
- 必须使用各云厂商官方 SDK

### 4.2 业务约束
- 仅采集只读监控数据，不执行任何写操作
- 不存储历史监控数据，仅作为 Prometheus 的数据源

### 4.3 成本约束
- 需要优化 API 调用次数，减少云厂商 API 配额消耗
- 需要优化数据传输量，降低 Prometheus 存储压力

## 5. 验收标准总结

### 5.1 功能验收
- [ ] 支持所有目标云平台和资源类型
- [ ] 多账号、多区域监控正常工作
- [ ] 资源发现和指标采集准确无误
- [ ] Prometheus 指标格式正确
- [ ] 配置管理灵活可靠
- [ ] 集群部署支持多种模式
- [ ] 性能优化措施有效
- [ ] 自身监控指标完整
- [ ] 管理接口认证安全可靠
- [ ] Kubernetes 部署顺利
- [ ] 日志管理灵活

### 5.2 非功能验收
- [ ] 性能指标达标
- [ ] 可靠性措施有效
- [ ] 可扩展性良好
- [ ] 安全性措施到位
- [ ] 可观测性充分
- [ ] 兼容性满足要求
- [ ] 可维护性达标

## 6. 附录

### 6.1 术语表
- **Exporter**：Prometheus 导出器，负责采集和暴露监控数据
- **Provider**：云厂商采集器，封装特定云平台的 API 调用
- **Collector**：采集调度器，负责协调多个 Provider 的采集任务
- **Discovery**：资源发现器，负责枚举云平台的资源
- **TTL**：Time To Live，缓存过期时间
- **Sharding**：分片，将采集任务分配到多个实例
- **Headless Service**：Kubernetes 无头服务，用于服务发现

### 6.2 参考文档
- [Prometheus 指标格式规范](https://prometheus.io/docs/instrumenting/exposition_formats/)
- [各云厂商监控 API 文档]
- [Helm Chart 最佳实践](https://helm.sh/docs/chart_best_practices/)
